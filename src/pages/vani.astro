---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import VaniList from "../components/VaniList.jsx";

// SERVER-SIDE FETCH
const response = await fetch(`${Astro.url.origin}/api/vani.json`);
const vaniData = await response.json();

// Get query parameters for filtering
const url = Astro.url;
const audioFilter = url.searchParams.getAll("audio");
const typeFilter = url.searchParams.getAll("type");
const yearFilter = url.searchParams.getAll("year");
const locationFilter = url.searchParams.getAll("location");
const page = parseInt(url.searchParams.get("page") || "1");

// Server-side filtering
const filteredLectures = vaniData.lectures.filter((lecture) => {
  // Audio filter
  if (audioFilter.length > 0) {
    const hasAudioMatch = audioFilter.includes("has_audio") && lecture.hasAudio;
    const noAudioMatch = audioFilter.includes("no_audio") && !lecture.hasAudio;
    if (!hasAudioMatch && !noAudioMatch) return false;
  }

  // Type filter
  if (typeFilter.length > 0) {
    const typeValue = lecture.type.toLowerCase().replace(/[^a-z0-9]/g, "_");
    if (!typeFilter.includes(typeValue)) return false;
  }

  // Year filter
  if (yearFilter.length > 0) {
    if (!yearFilter.includes(lecture.year)) return false;
  }

  // Location filter
  if (locationFilter.length > 0) {
    const locationValue = lecture.location.toLowerCase().replace(/[^a-z0-9]/g, "_");
    if (!locationFilter.includes(locationValue)) return false;
  }

  return true;
});

// Pagination
const perPage = 12;
const totalRecords = filteredLectures.length;
const totalPages = Math.ceil(totalRecords / perPage);
const startIndex = (page - 1) * perPage;
const endIndex = startIndex + perPage;
const paginatedLectures = filteredLectures.slice(startIndex, endIndex);

// Prepare data for client
const activeFilters = {
  audio: audioFilter,
  type: typeFilter,
  year: yearFilter,
  location: locationFilter,
};
---

<Layout page="vani">
  <!-- ================= PAGE HEADER ================= -->
  <section class="bg-white py-8 sm:py-10 lg:py-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <h1 class="font-pacifico text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-primary mb-3 sm:mb-4">
        Vani
      </h1>
      <span class="block w-16 sm:w-20 h-1 bg-primary rounded-full"></span>
    </div>
  </section>

  <!-- ── Strip divider ── -->
  <div class="h-2 bg-primary-hover"></div>

  <!-- ================= MAIN CONTENT ================= -->
  <section class="bg-section-bg min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-8 lg:py-12">
      <!-- React Component with client-side interactivity -->
      <VaniList
        client:load
        lectures={paginatedLectures}
        filters={vaniData.filters}
        activeFilters={activeFilters}
        totalRecords={totalRecords}
        currentPage={page}
        totalPages={totalPages}
        startIndex={startIndex}
      />
    </div>
  </section>
</Layout>